---
title: "Distribution Reporting Summary"
output: html_document
---



```{r, echo=FALSE, message=FALSE}
source("password.R") ## loads a variable called password
library(RCurl)
library(stringr)
upass = str_c("mcnepal:", password)
dataCSVDonor = getURI("http://ona.io/api/v1/data/65052.csv", userpwd=upass, httpauth = 1L)
donors = read.csv(textConnection(dataCSVDonor), na.strings="n/a")
dataCSVDistributions = getURI("http://ona.io/api/v1/data/65043.csv", userpwd=upass, httpauth = 1L)
distributions = read.csv(textConnection(dataCSVDistributions), na.strings="n/a")
previous_distributions = read.csv("before_july_9.csv")
VDC_List = read.csv("vdc_code_list.csv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

library(dplyr)

donors_NFI = filter(donors, distribution_information.kits_or_cash == 1)

donors_cash = filter(donors, distribution_information.kits_or_cash == 2)

donors_summary_NFI = donors_NFI %>% 
  group_by(distribution_information.vdc_name)%>%
  summarize(PlannedNFI = sum(distribution_information.number_of_kits))%>%
  arrange(distribution_information.vdc_name)

donors_summary_cash = donors_cash %>% 
  group_by(distribution_information.vdc_name)%>%
  summarize(PlannedCash = sum(distribution_information.cash_recipients))%>%
  arrange(distribution_information.vdc_name)

donors_summary = merge(donors_summary_NFI, donors_summary_cash, by.x = "distribution_information.vdc_name", by.y = "distribution_information.vdc_name", all = TRUE)

distributions_NFI = filter(distributions, distribution_information.kits_or_cash == 1)

distributions_cash = filter(distributions, distribution_information.kits_or_cash == 2)

distributions_summary_NFI = distributions_NFI %>% 
  group_by(distribution_information.vdc_name)%>%
  summarize(DistributedNFI = sum(review.total_distribution))%>%
  arrange(distribution_information.vdc_name)

distributions_summary_cash = distributions_cash %>% 
  group_by( distribution_information.vdc_name)%>%
  summarize(DistributedCash = sum(review.total_distribution))%>%
  arrange(distribution_information.vdc_name)

distribution_summary = merge(distributions_summary_NFI, distributions_summary_cash, by.x = "distribution_information.vdc_name", by.y = "distribution_information.vdc_name", all = TRUE)

distribution_summary = merge(donors_summary, distribution_summary, by.x = "distribution_information.vdc_name", by.y = "distribution_information.vdc_name", all = TRUE)

distribution_summary = merge(distribution_summary, previous_distributions, by.x = "distribution_information.vdc_name", by.y = "VDC", all=TRUE)

distribution_summary [is.na(distribution_summary)] = 0

distribution_summary$DistributedNFI = (distribution_summary$DistributedNFI + distribution_summary$Kits)
distribution_summary$DistributedCash = (distribution_summary$DistributedCash + distribution_summary$Cash)
distribution_summary$PlannedNFI = (distribution_summary$PlannedNFI + distribution_summary$Kits)
distribution_summary$PlannedCash = (distribution_summary$PlannedCash + distribution_summary$Cash)

distribution_summary = merge(distribution_summary, VDC_List, by.x = "distribution_information.vdc_name", by.y = "VDC", all.y = FALSE)

distribution_summary = distribution_summary [,c("District.y","distribution_information.vdc_name","PlannedNFI","DistributedNFI","PlannedCash","DistributedCash","Donor.y")] %>% arrange(District.y)
```

###Distribution Summary
```{r, echo=FALSE, message=FALSE}
knitr::kable(distribution_summary, col.names = c ("District","VDC","NFRI Allocated","NFRI Distributed","Cash Allocated","Cash Distributed", "Donor"))
```

**Distributed** column is drawn from the [Distribution Reporting Form](https://beta.ona.io/mcnepal/4384/52600), from `r nrow(distributions)` records.

Report Generated on `r date()`. 

